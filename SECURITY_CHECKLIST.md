# 部署前安全检查清单

**项目**: FSD担保交易平台
**版本**: v1.2.0+安全修复
**检查日期**: ___________
**检查人**: ___________

---

## ✅ 环境配置安全

### 必需环境变量
- [ ] `DATABASE_URL` 已设置(生产数据库)
- [ ] `JWT_SECRET` 已设置(至少32字符)
- [ ] `JWT_SECRET` 与开发环境不同
- [ ] `NEXTAUTH_SECRET` 已设置
- [ ] 生产环境变量中无默认/示例值

### 可选但推荐
- [ ] `ENCRYPTION_KEY` 已设置(用于敏感数据加密)
- [ ] `CSRF_SECRET` 已设置
- [ ] `REDIS_URL` 已设置(Token黑名单、限流)
- [ ] `SENTRY_DSN` 已设置(错误监控)

### 环境变量安全
- [ ] `.env` 文件已加入 `.gitignore`
- [ ] 生产密钥未在代码仓库中
- [ ] 密钥管理使用秘密管理工具(AWS Secrets Manager/Vault等)

---

## 🔐 认证和授权

### JWT配置
- [ ] JWT密钥硬编码已移除
- [ ] JWT签发包含 `issuer` 和 `audience`
- [ ] Token有效期合理(≤24小时,或有refresh机制)
- [ ] Token验证包含算法白名单
- [ ] 已实现Token黑名单(或refresh token机制)

### 密码安全
- [ ] Bcrypt轮数≥12
- [ ] 密码强度要求已实施
- [ ] 注册时验证密码复杂度
- [ ] 密码修改后旧Token失效

### 会话管理
- [ ] 实现登出功能(Token撤销)
- [ ] 敏感操作需要重新验证
- [ ] 会话超时配置合理

---

## 🛡️ API安全

### 认证检查
- [ ] 所有非公开API有认证检查
- [ ] Token从Header获取(非URL参数)
- [ ] 无效Token返回401状态码

### 授权检查
- [ ] 资源访问有权限验证
- [ ] 用户只能操作自己的资源
- [ ] 管理员权限正确验证
- [ ] 横向越权漏洞已修复

### CSRF防护
- [ ] POST/PATCH/DELETE请求有CSRF Token
- [ ] CSRF Token验证已实施
- [ ] SameSite Cookie已配置

### 输入验证
- [ ] 使用Zod或类似库验证输入
- [ ] 所有用户输入已验证
- [ ] 文件上传有类型和大小限制
- [ ] SQL注入防护(Prisma ORM)

### 输出编码
- [ ] API响应不包含敏感信息(密码、完整Token)
- [ ] 错误信息不泄露内部实现
- [ ] 敏感字段已脱敏(手机号、VIN等)

### 限流
- [ ] 登录接口有限流(防暴力破解)
- [ ] 支付接口有限流
- [ ] 通用API限流已配置
- [ ] 限流响应返回429状态码

---

## 💰 业务逻辑安全

### 订单安全
- [ ] 支付操作使用数据库事务
- [ ] 订单状态流转有权限检查
- [ ] 竞态条件已修复(支付、退款)
- [ ] 金额计算无浮点数精度问题

### 资金安全
- [ ] 余额操作使用事务
- [ ] 余额变更有审计日志
- [ ] 负数余额检查
- [ ] 提现操作有复审机制

### 申诉和退款
- [ ] 申诉处理有权限检查
- [ ] 退款操作使用事务
- [ ] 资金流向有明确记录
- [ ] 重复退款防护

---

## 📊 数据安全

### 数据库安全
- [ ] 数据库连接使用强密码
- [ ] 数据库不对公网开放
- [ ] 启用SSL连接
- [ ] 定期备份配置

### 敏感数据保护
- [ ] 密码使用Bcrypt加密存储
- [ ] 敏感字段加密存储(可选)
- [ ] 数据传输使用HTTPS
- [ ] PII数据访问有日志

### 数据脱敏
- [ ] API响应脱敏敏感信息
- [ ] 日志不包含密码、Token
- [ ] 手机号、车架号部分隐藏

---

## 📝 审计和日志

### 审计日志
- [ ] 管理员操作有审计日志
- [ ] 资金操作有审计日志
- [ ] 敏感数据访问有日志
- [ ] 日志包含IP地址

### 日志安全
- [ ] 日志不包含敏感信息
- [ ] 生产日志发送到远程服务
- [ ] 日志有保留期限
- [ ] 日志访问有权限控制

### 监控告警
- [ ] 异常登录告警
- [ ] 大额交易告警
- [ ] 错误率告警
- [ ] 性能监控配置

---

## 🌐 网络和传输安全

### HTTPS
- [ ] 生产环境强制HTTPS
- [ ] SSL证书有效且未过期
- [ ] 无混合内容(HTTP资源)
- [ ] HSTS已启用

### 安全响应头
- [ ] `Content-Security-Policy` 已配置
- [ ] `X-Frame-Options: DENY`
- [ ] `X-Content-Type-Options: nosniff`
- [ ] `Referrer-Policy` 已配置
- [ ] `Permissions-Policy` 已配置

### CORS
- [ ] CORS白名单配置
- [ ] 不使用 `*` 通配符
- [ ] 凭证传输正确配置

---

## 🔧 依赖和配置

### 依赖安全
- [ ] `pnpm audit` 无Critical/High漏洞
- [ ] 依赖版本已锁定(pnpm-lock.yaml)
- [ ] 已移除未使用的依赖
- [ ] 启用自动依赖更新(Dependabot)

### 配置安全
- [ ] 调试模式已关闭(生产环境)
- [ ] Source Maps已禁用(生产环境)
- [ ] 错误堆栈不暴露(生产环境)
- [ ] 示例文件已删除

---

## 🧪 安全测试

### 自动化测试
- [ ] OWASP ZAP扫描通过
- [ ] 依赖漏洞扫描通过
- [ ] 静态代码分析通过(SonarQube)

### 手动测试
- [ ] 认证绕过测试
- [ ] 权限提升测试
- [ ] SQL注入测试
- [ ] XSS测试
- [ ] CSRF测试
- [ ] 竞态条件测试

### 业务逻辑测试
- [ ] 订单状态流转测试
- [ ] 支付流程测试
- [ ] 退款流程测试
- [ ] 提现流程测试

---

## 🚀 部署安全

### 部署流程
- [ ] 生产部署需要审批
- [ ] 数据库迁移先在staging测试
- [ ] 回滚计划已准备
- [ ] 部署窗口已通知用户

### 访问控制
- [ ] 生产服务器SSH密钥认证
- [ ] 数据库访问限制IP
- [ ] 管理后台IP白名单
- [ ] VPN或堡垒机访问

### 备份和恢复
- [ ] 数据库每日备份
- [ ] 备份异地存储
- [ ] 恢复流程已测试
- [ ] RTO/RPO已定义

---

## 📋 合规性

### 数据保护
- [ ] 隐私政策已发布
- [ ] 用户同意机制已实施
- [ ] 数据删除功能("被遗忘权")
- [ ] 数据导出功能

### 行业标准
- [ ] OWASP Top 10 已覆盖
- [ ] PCI DSS合规(如适用)
- [ ] GDPR合规(如适用)

---

## 🔄 持续安全

### 定期审计
- [ ] 季度安全审计计划
- [ ] 年度渗透测试
- [ ] 依赖定期更新

### 安全培训
- [ ] 开发团队安全培训
- [ ] 安全编码规范
- [ ] 事件响应演练

### 应急响应
- [ ] 安全事件响应流程
- [ ] 联系人名单
- [ ] 沟通模板

---

## 📄 文档

### 技术文档
- [ ] API文档已更新
- [ ] 架构文档已更新
- [ ] 安全最佳实践文档

### 运维文档
- [ ] 部署文档
- [ ] 故障排查文档
- [ ] 监控告警文档

---

## 签署

### 检查完成
- 检查人: ___________
- 日期: ___________
- 签名: ___________

### 批准部署
- 批准人: ___________
- 日期: ___________
- 签名: ___________

---

## 备注

不符合项及整改计划:

```
[记录所有未通过的检查项及预计修复时间]

例如:
- [ ] CSRF防护 - 预计2天内完成
- [ ] 限流机制 - 预计3天内完成
```

---

**重要**: 所有标记为 🔴 Critical 的检查项必须全部通过才能部署到生产环境!
